@page "/login"
@using System.ComponentModel.DataAnnotations
@using System.Linq
@using Microsoft.AspNetCore.Components.Forms
@inject Work02.Interface.IAuthService AuthService
@inject NavigationManager Nav

<PageTitle>Login</PageTitle>

@* Center the login card vertically and horizontally *@
<div class="d-flex justify-content-center align-items-center min-vh-100">
    <div class="card p-4" style="width:360px;">
        <h5 class="card-title mb-3">Enter PIN</h5>

        @* Show validation or authentication errors *@
        @if (!string.IsNullOrEmpty(_error))
        {
            <div class="alert alert-danger">@_error</div>
        }

        <EditForm Model="_model" OnSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-3">
                <label class="form-label">PIN</label>
                <InputText id="pinInput"
                           class="form-control"
                           @bind-Value="_model.Pin"
                           maxlength="4"
                           inputmode="numeric"
                           autofocus />
                <ValidationMessage For="() => _model.Pin" />
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-primary" type="submit" disabled="@_isSubmitting">Enter</button>
                <button class="btn btn-outline-secondary" type="button" @onclick="Clear" disabled="@_isSubmitting">Clear</button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    // Simple form model with validation attributes
    private class Model
    {
        [Required(ErrorMessage = "PIN is required")]
        [RegularExpression(@"^\d{4}$", ErrorMessage = "PIN must be 4 digits")]
        public string Pin { get; set; } = string.Empty;
    }

    private readonly Model _model = new();
    private string? _error;
    private bool _isSubmitting;

    protected override async Task OnInitializedAsync()
    {
        // If the user is already authenticated (persisted), redirect to home.
        await Task.Yield(); // ensure async
        if (AuthService.IsAuthenticated)
        {
            Nav.NavigateTo("/");
        }
    }

    private async Task HandleSubmit(EditContext editContext)
    {
        _error = null;
        _isSubmitting = true;

        try
        {
            if (!editContext.Validate())
            {
                var messages = editContext.GetValidationMessages();
                _error = messages.FirstOrDefault() ?? "Invalid input.";
                return;
            }

            var pin = _model.Pin?.Trim() ?? string.Empty;
            var ok = await AuthService.ValidatePinAsync(pin);

            if (ok)
            {
                // Navigate with reload to ensure App.razor picks up auth state.
                Nav.NavigateTo("/", true);
            }
            else
            {
                _error = "Invalid PIN";
                _model.Pin = string.Empty;
            }
        }
        catch (Exception ex)
        {
            _error = "An error occurred while validating PIN.";
            Console.WriteLine(ex);
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }

    private void Clear()
    {
        _model.Pin = string.Empty;
        _error = null;
    }
}